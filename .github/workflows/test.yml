name: Test Environment Backup

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: 'The name of the environment to backup/restore'
        required: true
        default: 'staging'
      operation:
        description: 'Operation to perform'
        required: true
        default: 'create'
        type: choice
        options:
        - create
        - list
        - download
        - delete
      backup_id:
        description: 'Backup ID for download operation (use "latest" for most recent)'
        required: false
        default: 'latest'
      type:
        description: 'The type of data to backup'
        required: true
        default: 'database'
        type: choice
        options:
        - database
        - filesystem
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mock-api:
        image: ghcr.io/quantcdn/quant-mock-api:4.3.0
        ports:
          - 4010:4010
        options: >-
          --health-cmd "nc -z 127.0.0.1 4010"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v5

      - name: Test backup operation
        uses: ./
        id: backup-operation
        with:
          api_key: ${{ secrets.QUANT_API_KEY }}
          base_url: http://mock-api:4010
          environment_name: ${{ inputs.environment_name || 'staging' }}
          operation: ${{ inputs.operation || 'create' }}
          backup_id: ${{ inputs.backup_id }}
          backup_name: test-backup-${{ github.run_number }}
          app_name: 'actions'
          organization: ${{ secrets.QUANT_ORGANIZATION }}
          type: ${{ inputs.type || 'database' }}
          wait: true
          
      - name: Debug Outputs
        run: |
          echo "Operation: ${{ inputs.operation || 'create' }}"
          echo "Success: ${{ steps.backup-operation.outputs.success }}"
          echo "Backup ID: ${{ steps.backup-operation.outputs.backup_id }}"
          echo "Backup List: ${{ steps.backup-operation.outputs.backup_list }}"
          echo "Download URL: ${{ steps.backup-operation.outputs.download_url }}"
          echo "Resolved Backup ID: ${{ steps.backup-operation.outputs.resolved_backup_id }}"
          echo "Resolved Backup Name: ${{ steps.backup-operation.outputs.resolved_backup_name }}"
          echo "Resolved Backup Created: ${{ steps.backup-operation.outputs.resolved_backup_created_at }}"
          echo "Deleted Count: ${{ steps.backup-operation.outputs.deleted_count }}"
          echo "Deleted Backups: ${{ steps.backup-operation.outputs.deleted_backups }}"

  # Test all operations automatically when pushing to main
  test-all-operations:
    runs-on: ubuntu-latest
    services:
      mock-api:
        image: ghcr.io/quantcdn/quant-mock-api:4.3.0
        ports:
          - 4010:4010
        options: >-
          --health-cmd "nc -z 127.0.0.1 4010"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    if: github.event_name == 'push'
    strategy:
      matrix:
        operation: [create, list, download]
        include:
          - operation: download
            backup_id: latest
    steps:
      - uses: actions/checkout@v4

      - name: Test ${{ matrix.operation }} operation
        uses: ./
        id: test-operation
        with:
          api_key: ${{ secrets.QUANT_API_KEY }}
          base_url: http://mock-api:4010
          environment_name: 'staging'
          operation: ${{ matrix.operation }}
          backup_id: ${{ matrix.backup_id }}
          backup_name: auto-test-backup-${{ github.run_number }}
          app_name: 'actions'
          organization: ${{ secrets.QUANT_ORGANIZATION }}
          type: 'database'
          wait: ${{ matrix.operation == 'create' && 'true' || 'false' }}
          
      - name: Validate ${{ matrix.operation }} output
        run: |
          echo "Testing ${{ matrix.operation }} operation"
          echo "Success: ${{ steps.test-operation.outputs.success }}"
          
          # Validate operation-specific outputs
          if [ "${{ matrix.operation }}" == "create" ]; then
            if [ -z "${{ steps.test-operation.outputs.backup_id }}" ]; then
              echo "❌ Create operation should return backup_id"
              exit 1
            fi
            echo "✅ Create operation returned backup_id: ${{ steps.test-operation.outputs.backup_id }}"
          fi
          
          if [ "${{ matrix.operation }}" == "list" ]; then
            if [ -z "${{ steps.test-operation.outputs.backup_list }}" ]; then
              echo "❌ List operation should return backup_list"
              exit 1
            fi
            echo "✅ List operation returned backup_list: ${{ steps.test-operation.outputs.backup_list }}"
          fi
          
          if [ "${{ matrix.operation }}" == "download" ]; then
            if [ -z "${{ steps.test-operation.outputs.download_url }}" ]; then
              echo "❌ Download operation should return download_url"
              exit 1
            fi
            echo "✅ Download operation returned download_url: ${{ steps.test-operation.outputs.download_url }}"
            
            # Validate 'latest' resolution outputs
            if [ "${{ matrix.backup_id }}" == "latest" ]; then
              if [ -z "${{ steps.test-operation.outputs.resolved_backup_id }}" ]; then
                echo "❌ Download with 'latest' should return resolved_backup_id"
                exit 1
              fi
              echo "✅ Latest backup resolved: ${{ steps.test-operation.outputs.resolved_backup_name }}"
            fi
          fi
  
  # Cleanup test backups after successful tests
  cleanup-test-backups:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && always()
    needs: test-all-operations
    steps:
      - uses: actions/checkout@v4

      - name: Delete old test backups
        uses: ./
        with:
          api_key: ${{ secrets.QUANT_API_KEY }}
          environment_name: 'staging'
          operation: delete
          older_than_days: 7
          app_name: 'actions'
          organization: ${{ secrets.QUANT_ORGANIZATION }}
          type: 'database'
      
      - name: Show cleanup results
        run: echo "Cleaned up test backups older than 7 days"