name: Test Environment Backup

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        default: 'create'
        type: choice
        options:
        - create
        - list
        - download
        - delete
      type:
        description: 'The type of data to backup'
        required: true
        default: 'database'
        type: choice
        options:
        - database
        - filesystem

jobs:
  test-all-operations:
    runs-on: ubuntu-latest
    services:
      mock-api:
        image: ghcr.io/quantcdn/quant-mock-api:4.4.0-863533a
        ports:
          - 4010:4010
        options: >-
          --health-cmd "nc -z 127.0.0.1 4010"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    strategy:
      fail-fast: false
      matrix:
        operation: [create, list, download, delete]
        type: [database, filesystem]
        include:
          - operation: download
            backup_id: latest
          - operation: delete
            backup_id: backup-test-123
    steps:
      - uses: actions/checkout@v4

      - name: Test ${{ matrix.operation }} ${{ matrix.type }} operation
        uses: ./
        id: test-operation
        with:
          # Use mock API credentials (any value works with mock)
          api_key: test-api-key-12345
          base_url: http://localhost:4010
          # Use values that match mock API responses
          organization: test-org
          app_name: test-app
          environment_name: test-env
          # Operation parameters
          operation: ${{ matrix.operation }}
          type: ${{ matrix.type }}
          backup_id: ${{ matrix.backup_id }}
          backup_name: test-backup-${{ github.run_number }}
          # Wait for completion on create operations
          wait: ${{ matrix.operation == 'create' && 'true' || 'false' }}
          
      - name: Validate ${{ matrix.operation }} output
        run: |
          echo "Testing ${{ matrix.operation }} ${{ matrix.type }} operation"
          echo "Success: ${{ steps.test-operation.outputs.success }}"
          
          # Validate operation-specific outputs
          if [ "${{ matrix.operation }}" == "create" ]; then
            if [ -z "${{ steps.test-operation.outputs.backup_id }}" ]; then
              echo "❌ Create operation should return backup_id"
              exit 1
            fi
            echo "✅ Create operation returned backup_id: ${{ steps.test-operation.outputs.backup_id }}"
          fi
          
          if [ "${{ matrix.operation }}" == "list" ]; then
            if [ -z "${{ steps.test-operation.outputs.backup_list }}" ]; then
              echo "❌ List operation should return backup_list"
              exit 1
            fi
            echo "✅ List operation returned backup_list"
            echo "${{ steps.test-operation.outputs.backup_list }}" | head -c 200
          fi
          
          if [ "${{ matrix.operation }}" == "download" ]; then
            if [ -z "${{ steps.test-operation.outputs.download_url }}" ]; then
              echo "❌ Download operation should return download_url"
              exit 1
            fi
            echo "✅ Download operation returned download_url: ${{ steps.test-operation.outputs.download_url }}"
            
            # Validate 'latest' resolution outputs
            if [ "${{ matrix.backup_id }}" == "latest" ]; then
              if [ -z "${{ steps.test-operation.outputs.resolved_backup_id }}" ]; then
                echo "❌ Download with 'latest' should return resolved_backup_id"
                exit 1
              fi
              echo "✅ Latest backup resolved: ${{ steps.test-operation.outputs.resolved_backup_name }}"
              echo "   Backup ID: ${{ steps.test-operation.outputs.resolved_backup_id }}"
              echo "   Created at: ${{ steps.test-operation.outputs.resolved_backup_created_at }}"
            fi
          fi
          
          if [ "${{ matrix.operation }}" == "delete" ]; then
            if [ -z "${{ steps.test-operation.outputs.deleted_count }}" ]; then
              echo "❌ Delete operation should return deleted_count"
              exit 1
            fi
            echo "✅ Delete operation deleted ${{ steps.test-operation.outputs.deleted_count }} backup(s)"
          fi

  # Manual test job for workflow_dispatch
  manual-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    services:
      mock-api:
        image: ghcr.io/quantcdn/quant-mock-api:4.4.0-863533a
        ports:
          - 4010:4010
        options: >-
          --health-cmd "nc -z 127.0.0.1 4010"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Test ${{ inputs.operation }} operation
        uses: ./
        id: backup-operation
        with:
          api_key: test-api-key-12345
          base_url: http://localhost:4010
          organization: test-org
          app_name: test-app
          environment_name: test-env
          operation: ${{ inputs.operation }}
          type: ${{ inputs.type }}
          backup_name: manual-test-backup-${{ github.run_number }}
          wait: true
          
      - name: Debug Outputs
        run: |
          echo "Operation: ${{ inputs.operation }}"
          echo "Type: ${{ inputs.type }}"
          echo "Success: ${{ steps.backup-operation.outputs.success }}"
          echo "Backup ID: ${{ steps.backup-operation.outputs.backup_id }}"
          echo "Backup List: ${{ steps.backup-operation.outputs.backup_list }}"
          echo "Download URL: ${{ steps.backup-operation.outputs.download_url }}"
          echo "Resolved Backup ID: ${{ steps.backup-operation.outputs.resolved_backup_id }}"
          echo "Resolved Backup Name: ${{ steps.backup-operation.outputs.resolved_backup_name }}"
          echo "Resolved Backup Created: ${{ steps.backup-operation.outputs.resolved_backup_created_at }}"
          echo "Deleted Count: ${{ steps.backup-operation.outputs.deleted_count }}"
          echo "Deleted Backups: ${{ steps.backup-operation.outputs.deleted_backups }}"